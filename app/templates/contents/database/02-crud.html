{% extends 'base.html' %}

{% block title %} PostgreSQL {% endblock %}

{% block header %} CRUD basic {% endblock %}

{% block content %}
<section>
<h4>CREATE TABLE</h4>
<p>SERIAL : auto increment, BIGSERIAL</p>
<pre>=# CREATE TABLE person (
  id SERIAL PRIMARY KEY NOT NULL,
  name VARCHAR(100) NOT NULL,
  age INT NOT NULL,
  address VARCHAR(255) NOT NULL,
  created_at TIMESTAMP
);</pre>

  <h5>CREATE TABLE : 다른 테이블을 이용해서 생성</h5>
    <pre>CREATE TABLE new_table_name AS<br/>
SELECT column1, column2,...<br/>
FROM existing_table_name<br/>
WHERE ....; </pre>
      
  <pre>CREATE TABLE TestTable AS<br/>
SELECT customername, contactname FROM customers; </pre>
    <h5>import json file : mysqlsh --js mode에서 실행</h5>
    
<h4>DROM TABLE</h4>
  <pre>=# DROP TABLE person;</pre>
<h5>TRUNCATE TABLE table_name; -- 데이터만 지우고 테이블을 그대로 둠</h5>

<h4>ALTER TABLE</h4>
<h5>RENAME TABLE</h5>
  <pre>ALTER TABLE old_table_name RENAME TO new_table_name;<br/>
ALTER TABLE Customers RENAME TO Customers_NEW;</pre>

<h5>ADD COLUMN</h5>
    <pre>ALTER TABLE table_name ADD column_name datatype;<br/>
  ALTER TABLE Customers ADD Email varchar(255);</pre>

<h5>DROP COLUMN</h5>
    <pre>ALTER TABLE table_name DROP COLUMN column_name; <br/>
  ALTER TABLE Customers DROP COLUMN Email;</pre>

<h5>RENAME COLUMN</h5>
    <pre>ALTER TABLE table_name RENAME COLUMN old_column_name TO new_column_name;<br/>
ALTER TABLE Customers RENAME COLUMN Email TO EmailAddress;</pre>

<h5>MODIFY COLUMN</h5>
    <pre>ALTER TABLE table_name MODIFY COLUMN column_name datatype;
  ALTER TABLE Customers MODIFY COLUMN Email varchar(100);
  ALTER TABLE Customers ALTER COLUMN Email varchar(100);
  
  alter table users add primary key(id);
mydb=# alter table users alter column id drop default;
ALTER TABLE
mydb=# alter table users alter column id add generated by default as identity;</pre>
<h5>COLUMN 위치변경</h5>
    <pre>-- email 위치를 last_name 뒤로 이동<br/>
ALTER TABLE table_name MODIFY email AFTER last_name;<br/>
ALTER TABLE table_name MODIFY email FIRST;</pre>

<h4>import json: mysqlsh mode에서</h4>
  <pre>-- type을 json으로 지정하고,
-- 테이블을 생성한 후에 json 파일을 import
  \\sql
  CREATE TABLE car_json (
    id SERIAL NOT NULL PRIMARY KEY, car_info JSON NOT NULL);
  \\js
   -- 경로는 본인에 맞게 수정 '/로 해야함'
  util.importJson('C:/Users/slow3/Downloads/car.json',
    { schema: 'mydb', table:'car_json', tableColumn: 'car_info' } );
  json data format은 [] 없고, 끝에 ","도 없어야함
    {"id":1,"make":"Honda","model":"CR-Z","model_year":2011}
    {"id":2,"make":"Lincoln","model":"Town Car","model_year":1988}
    {"id":3,"make":"Scion","model":"iQ","model_year":2012}
    ...
  \sql select * from car_json\G    -- 여기서 ";" 없어야 함
  select * from car_json\G;    -- 여기서는 ";" 있어야 함</pre>

<h4>INSERT</h4>
<pre>=# INSERT INTO person (name, age, address, created_at)
    VALUES ('John Doe', 30, '123 Main St', NOW()),
    ('John Doe', 30, '123 Main St', '2019-02-22');</pre>
<h5>Import data from file : https://www.mockaroo.com/</h5>
<pre>=# \copy person FROM '/path/to/file.csv' DELIMITER ',' CSV HEADER;</pre>
<pre>=# \i '/path/to/file.sql';</pre>

<h4>INSERT</h4>
<pre>=# INSERT INTO person (name, age, address, created_at)
    VALUES ('John Doe', 30, '123 Main St', NOW()),
    ('John Doe', 30, '123 Main St', '2019-02-22');</pre>
<h5>Import data from file : https://www.mockaroo.com/</h5>
<pre>=# \copy person FROM '/path/to/file.csv' DELIMITER ',' CSV HEADER;
=# \i '/path/to/file.sql';</pre>

<!-- ######### UPDATE table_name SET ########-->
<h4>UPDATE</h4>
  <pre>UPDATE table_name
    SET column1 = value1, column2 = value2, ...
    WHERE condition;</pre>
  <pre>UPDATE customer
    SET name = '김관용', country = '한국', address = '대전시 서구'
    WHERE id = 2;</pre>
<!-- ############## DELETE FROM ################-->
<h4>DELETE</h4>
  <pre>DELETE FROM table_name WHERE condition;</pre>
  <pre>DELETE FROM customer
  WHERE email LIKE 'malebrooke6@%';
DELETE FROM car
  WHERE price = null;</pre>
<!-- ######### on delete: foreign key가 있을 때 ############-->  
<h5>ON DELETE SET NULL ; FOREIGN KEY가 지워지면 이를 참조하는 테이블의 값을 NULL로 함</h5>
<pre>alter table employees drop constraint FK_Office_id;
ALTER TABLE employees ADD FOREIGN(office_id) 
-- 부모 테이블에서 삭제시 자식 테이블의 값을 NULL로 함
  REFERENCES offices(office_id) ON DELETE SET NULL; 
-- OR
ALTER TABLE table_name
  ADD CONSTRAINT constraint_name -- 제약조건 이름(같은 이름)
  FOREIGN KEY (column_name)
  REFERENCES parent_table (parent_column)
  ON DELETE CASCADE; -- 부모 테이블에서 삭제시 자식 테이블도 삭제
  -- 부모 테이블에서 삭제시 자식 테이블의 값을 NULL로 함
--OR,  ON DELETE NULL; 
</pre>
<pre>ALTER TABLE employees 
  ADD CONSTRAINT fk_employees_office_id 
  FOREIGN KEY(office_id) REFERENCES offices(office_id) ON DELETE CASCADE;</pre>
<h5>ON DELETE SET CASCADE ; FOREIGN KEY가 지워지면 이를 참조하는 테이블의 ROW를 지움</h5>
<!-- ######### TABLE 구조는 남기고 데이터만 지움 ###########-->  
<h4>TRUNCATE</h4>  
  <pre>TRUNCATE TABLE table_name;</pre>
  <pre>TRUNCATE TABLE customer;</pre>
<!-- ########### 테이블 삭제 drop ###############-->
<h4>delete table</h4>
  <pre>DROP TABLE table_name;</pre>
<!-- ########## COLUNM 위치이동 #################-->
<h4>column 위치 이동</h4>
  <pre>ALTER TABLE t_name MODIFY COLUMN age INT AFTER last_name;</pre>
<!-- ############## VIEW ###################-->
<h3>VIEW</h3>
<h4>기존 테이블을 바탕으로 새로운 가상의 테이블을 생성(자동업데이트)</h4>
  <pre>CREATE VIEW view_name AS
SELECT column1, column2, ...
FROM table_name
WHERE condition;</pre>
<pre>CREATE VIES em_office AS 
  SELECT first_name, offices.address FROM employees 
  LEFT JOIN offices ON employees.office_id = offices.office_id;
SELECT * FROM em_office;</pre>
<pre>-- 다룰 때는 일반 테이블 다루듯이 하면됨
SELECT * FROM view_name;
DROP VIEW view_name;
ALTER VIEW view_name AS SELECT ...; -- 기존 뷰를 변경
CREATE OR REPLACE VIEW view_name AS SELECT ...; -- 기존 뷰를 변경</pre>
</section>

{% endblock %}